<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¿ä½å›¾å¯è§†åŒ– - ArkOne æµ‹åºæµç¨‹é…ç½®ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .plate-container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .plate-canvas-wrapper {
      flex: 1;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .plate-info-panel {
      width: 320px;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #plateCanvas {
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }

    .legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
    }

    .selected-position {
      background: #F0F9FF;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      border: 2px solid var(--primary-color);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .stat-card {
      background: var(--bg-color);
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <div>
        <a href="index.html" class="btn btn-text">â† è¿”å›é¦–é¡µ</a>
        <h1 class="page-title">æ¿ä½å›¾å¯è§†åŒ–</h1>
      </div>
      <div class="btn-group">
        <select class="form-select" id="containerSelect" onchange="handleContainerChange()" style="width: 200px;">
          <option value="">é€‰æ‹©å®¹å™¨</option>
          <option value="P096-001" selected>P096-001 (96å­”æ¿)</option>
          <option value="P096-002">P096-002 (96å­”æ¿)</option>
          <option value="P048-001">P048-001 (48å­”æ¿)</option>
        </select>
        <button class="btn btn-default" onclick="handleRefresh()">ğŸ”„ åˆ·æ–°</button>
        <button class="btn btn-primary" onclick="handleExport()">ğŸ“¤ å¯¼å‡º</button>
      </div>
    </div>

    <div class="plate-container">
      <!-- æ¿ä½å›¾ç”»å¸ƒ -->
      <div class="plate-canvas-wrapper">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <h3 style="margin: 0; color: var(--text-primary);">96å­”æ¿ - P096-001</h3>
            <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">
              ä½¿ç”¨ç‡: <strong style="color: var(--primary-color);">45/96 (46.9%)</strong>
            </p>
          </div>
          <div class="btn-group">
            <button class="btn btn-text" onclick="handleZoomIn()">ğŸ”+</button>
            <button class="btn btn-text" onclick="handleZoomOut()">ğŸ”-</button>
            <button class="btn btn-text" onclick="handleReset()">â†»</button>
          </div>
        </div>

        <canvas id="plateCanvas" width="800" height="600"></canvas>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #F5F7FA;"></div>
            <span>ç©ºé—²</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #409EFF;"></div>
            <span>å·²ä½¿ç”¨</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #67C23A;"></div>
            <span>å½“å‰é€‰ä¸­</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #E6A23C;"></div>
            <span>å¼‚å¸¸</span>
          </div>
        </div>
      </div>

      <!-- ä¿¡æ¯é¢æ¿ -->
      <div class="plate-info-panel">
        <h3 style="margin: 0 0 16px 0; color: var(--text-primary);">å®¹å™¨ä¿¡æ¯</h3>

        <div class="info-row">
          <div class="info-label">å®¹å™¨ç¼–å·:</div>
          <div class="info-value">P096-001</div>
        </div>

        <div class="info-row">
          <div class="info-label">å®¹å™¨ç±»å‹:</div>
          <div class="info-value">96å­”æ¿</div>
        </div>

        <div class="info-row">
          <div class="info-label">åˆ›å»ºæ—¶é—´:</div>
          <div class="info-value">2026-02-20</div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">45</div>
            <div class="stat-label">å·²ä½¿ç”¨</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">51</div>
            <div class="stat-label">ç©ºé—²</div>
          </div>
        </div>

        <!-- æ•°æ®å½•å…¥æ¨¡å¼ -->
        <div style="margin-top: 24px; padding: 16px; background: #F0F9FF; border-radius: 8px; border: 2px solid var(--primary-color);">
          <h4 style="margin: 0 0 12px 0; color: var(--primary-color);">ğŸ“ æ•°æ®å½•å…¥æ¨¡å¼</h4>
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">96å­”æ¿å·</label>
            <input
              type="text"
              id="plateNumber"
              class="form-input"
              placeholder="è¾“å…¥æ¿å·ï¼Œå¦‚: P096-001"
              style="width: 100%;"
            >
          </div>
          <button class="btn btn-primary" onclick="handleBatchFillAll()" style="width: 100%;">
            âš¡ ä¸€é”®å¡«å……æ‰€æœ‰å­”ä½
          </button>
          <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary); text-align: center;">
            å°†è‡ªåŠ¨ä¸º96ä¸ªå­”ä½å¡«å……æ¿å·å’Œå­”ä½ä¿¡æ¯
          </div>
        </div>

        <div id="selectedInfo" style="display: none;">
          <h4 style="margin: 24px 0 12px 0; color: var(--text-primary);">é€‰ä¸­å­”ä½</h4>
          <div class="selected-position">
            <div style="font-size: 18px; font-weight: 600; color: var(--primary-color); margin-bottom: 12px;">
              å­”ä½: <span id="selectedPosition">-</span>
            </div>
            <div style="font-size: 14px; color: var(--text-regular); line-height: 1.8;">
              <div>æ ·æœ¬ç¼–å·: <strong id="selectedSampleId">-</strong></div>
              <div>æ ·æœ¬åç§°: <strong id="selectedSampleName">-</strong></div>
              <div>å½“å‰èŠ‚ç‚¹: <strong id="selectedNode">-</strong></div>
              <div>çŠ¶æ€: <span id="selectedStatus" class="status-badge in-progress">è¿›è¡Œä¸­</span></div>
            </div>
            <button class="btn btn-primary" onclick="viewSampleDetail()" style="width: 100%; margin-top: 12px;">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">å¿«æ·æ“ä½œ</h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button class="btn btn-default" onclick="handleBatchSelect()" style="width: 100%;">
              æ‰¹é‡é€‰æ‹©
            </button>
            <button class="btn btn-default" onclick="handleClearSelection()" style="width: 100%;">
              æ¸…é™¤é€‰æ‹©
            </button>
            <button class="btn btn-default" onclick="handleFindEmpty()" style="width: 100%;">
              æŸ¥æ‰¾ç©ºä½
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts.js"></script>
  <script>
    const canvas = document.getElementById('plateCanvas');
    const ctx = canvas.getContext('2d');

    let plateConfig = {
      type: '96å­”æ¿',
      rows: 8,
      cols: 12,
      wellSize: 40,
      gap: 10,
      offsetX: 80,
      offsetY: 60
    };

    let positions = [];
    let selectedPosition = null;
    let scale = 1;

    // åˆå§‹åŒ–æ¿ä½æ•°æ®
    function initPlateData() {
      positions = [];
      const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

      for (let r = 0; r < plateConfig.rows; r++) {
        for (let c = 0; c < plateConfig.cols; c++) {
          const position = `${rows[r]}${String(c + 1).padStart(2, '0')}`;
          const isUsed = Math.random() > 0.5;

          positions.push({
            position,
            row: r,
            col: c,
            status: isUsed ? 'used' : 'empty',
            sampleId: isUsed ? `AK2026022400${Math.floor(Math.random() * 100)}` : null,
            sampleName: isUsed ? `Sample-${Math.floor(Math.random() * 100)}` : null,
            currentNode: isUsed ? ['æ‘‡èŒ', 'æ ¸é…¸æå–', 'æ ·æœ¬å‰å¤„ç†'][Math.floor(Math.random() * 3)] : null
          });
        }
      }
    }

    // ç»˜åˆ¶æ¿ä½å›¾
    function drawPlate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.scale(scale, scale);

      const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

      // ç»˜åˆ¶åˆ—æ ‡ç­¾
      ctx.fillStyle = var(--text-secondary);
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      for (let c = 0; c < plateConfig.cols; c++) {
        const x = plateConfig.offsetX + c * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;
        ctx.fillText(c + 1, x, plateConfig.offsetY - 20);
      }

      // ç»˜åˆ¶è¡Œæ ‡ç­¾
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let r = 0; r < plateConfig.rows; r++) {
        const y = plateConfig.offsetY + r * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;
        ctx.fillText(rows[r], plateConfig.offsetX - 20, y);
      }

      // ç»˜åˆ¶å­”ä½
      positions.forEach(pos => {
        const x = plateConfig.offsetX + pos.col * (plateConfig.wellSize + plateConfig.gap);
        const y = plateConfig.offsetY + pos.row * (plateConfig.wellSize + plateConfig.gap);

        // ç»˜åˆ¶åœ†å½¢å­”ä½
        ctx.beginPath();
        ctx.arc(
          x + plateConfig.wellSize / 2,
          y + plateConfig.wellSize / 2,
          plateConfig.wellSize / 2 - 2,
          0,
          Math.PI * 2
        );

        // æ ¹æ®çŠ¶æ€å¡«å……é¢œè‰²
        if (selectedPosition === pos.position) {
          ctx.fillStyle = '#67C23A';
        } else if (pos.status === 'used') {
          ctx.fillStyle = '#409EFF';
        } else if (pos.status === 'exception') {
          ctx.fillStyle = '#E6A23C';
        } else {
          ctx.fillStyle = '#F5F7FA';
        }
        ctx.fill();

        // ç»˜åˆ¶è¾¹æ¡†
        ctx.strokeStyle = '#DCDFE6';
        ctx.lineWidth = 1;
        ctx.stroke();

        // ç»˜åˆ¶ä½ç½®æ ‡ç­¾
        ctx.fillStyle = pos.status === 'empty' ? '#909399' : '#FFFFFF';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(
          pos.position,
          x + plateConfig.wellSize / 2,
          y + plateConfig.wellSize / 2
        );
      });

      ctx.restore();
    }

    // å¤„ç†ç‚¹å‡»äº‹ä»¶
    canvas.addEventListener('click', (event) => {
      const rect = canvas.getBoundingClientRect();
      const x = (event.clientX - rect.left) / scale;
      const y = (event.clientY - rect.top) / scale;

      // æŸ¥æ‰¾ç‚¹å‡»çš„å­”ä½
      for (let pos of positions) {
        const wellX = plateConfig.offsetX + pos.col * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;
        const wellY = plateConfig.offsetY + pos.row * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;

        const distance = Math.sqrt((x - wellX) ** 2 + (y - wellY) ** 2);

        if (distance <= plateConfig.wellSize / 2) {
          handlePositionClick(pos);
          break;
        }
      }
    });

    // å¤„ç†å­”ä½ç‚¹å‡»
    function handlePositionClick(pos) {
      selectedPosition = pos.position;
      drawPlate();

      // æ›´æ–°ä¿¡æ¯é¢æ¿
      const selectedInfo = document.getElementById('selectedInfo');
      selectedInfo.style.display = 'block';

      document.getElementById('selectedPosition').textContent = pos.position;

      if (pos.status === 'used') {
        document.getElementById('selectedSampleId').textContent = pos.sampleId;
        document.getElementById('selectedSampleName').textContent = pos.sampleName;
        document.getElementById('selectedNode').textContent = pos.currentNode;
        document.getElementById('selectedStatus').textContent = 'è¿›è¡Œä¸­';
      } else {
        document.getElementById('selectedSampleId').textContent = 'ç©ºé—²';
        document.getElementById('selectedSampleName').textContent = '-';
        document.getElementById('selectedNode').textContent = '-';
        document.getElementById('selectedStatus').textContent = 'ç©ºé—²';
        document.getElementById('selectedStatus').className = 'status-badge';
      }

      showMessage(`å·²é€‰æ‹©å­”ä½: ${pos.position}`, 'info');
    }

    // å®¹å™¨åˆ‡æ¢
    function handleContainerChange() {
      const select = document.getElementById('containerSelect');
      const value = select.value;

      if (value.includes('48')) {
        plateConfig.rows = 6;
        plateConfig.cols = 8;
      } else {
        plateConfig.rows = 8;
        plateConfig.cols = 12;
      }

      initPlateData();
      drawPlate();
      showMessage('å®¹å™¨å·²åˆ‡æ¢', 'success');
    }

    // åˆ·æ–°
    function handleRefresh() {
      initPlateData();
      drawPlate();
      showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
    }

    // å¯¼å‡º
    function handleExport() {
      showMessage('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // æ”¾å¤§
    function handleZoomIn() {
      scale = Math.min(scale + 0.1, 2);
      drawPlate();
    }

    // ç¼©å°
    function handleZoomOut() {
      scale = Math.max(scale - 0.1, 0.5);
      drawPlate();
    }

    // é‡ç½®
    function handleReset() {
      scale = 1;
      drawPlate();
    }

    // æ‰¹é‡é€‰æ‹©
    function handleBatchSelect() {
      showMessage('æ‰¹é‡é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // æ¸…é™¤é€‰æ‹©
    function handleClearSelection() {
      selectedPosition = null;
      document.getElementById('selectedInfo').style.display = 'none';
      drawPlate();
      showMessage('å·²æ¸…é™¤é€‰æ‹©', 'info');
    }

    // æŸ¥æ‰¾ç©ºä½
    function handleFindEmpty() {
      const emptyPositions = positions.filter(p => p.status === 'empty');
      if (emptyPositions.length > 0) {
        const firstEmpty = emptyPositions[0];
        handlePositionClick(firstEmpty);
        showMessage(`æ‰¾åˆ° ${emptyPositions.length} ä¸ªç©ºä½ï¼Œå·²å®šä½åˆ°ç¬¬ä¸€ä¸ª`, 'success');
      } else {
        showMessage('æ²¡æœ‰ç©ºé—²å­”ä½', 'warning');
      }
    }

    // æŸ¥çœ‹æ ·æœ¬è¯¦æƒ…
    function viewSampleDetail() {
      if (selectedPosition) {
        const pos = positions.find(p => p.position === selectedPosition);
        if (pos && pos.sampleId) {
          window.open(`sample-detail.html?id=${pos.sampleId}`, '_blank');
        }
      }
    }

    // ä¸€é”®å¡«å……æ‰€æœ‰å­”ä½
    function handleBatchFillAll() {
      const plateNumber = document.getElementById('plateNumber').value.trim();

      if (!plateNumber) {
        showMessage('è¯·è¾“å…¥96å­”æ¿å·', 'error');
        return;
      }

      if (!confirm(`ç¡®å®šè¦ä¸ºæ‰€æœ‰96ä¸ªå­”ä½å¡«å……æ¿å· "${plateNumber}" å—?`)) {
        return;
      }

      showMessage('æ­£åœ¨å¡«å……...', 'info');

      // åˆ›å»ºç»¿è‰²æ³¢çº¹åŠ¨ç”»æ•ˆæœ
      let delay = 0;
      positions.forEach((pos, index) => {
        setTimeout(() => {
          // æ›´æ–°å­”ä½çŠ¶æ€
          pos.status = 'used';
          pos.plateNumber = plateNumber;
          pos.sampleId = `AK2026022400${String(index + 1).padStart(2, '0')}`;
          pos.sampleName = `Sample-${index + 1}`;
          pos.currentNode = 'æ ¸é…¸æå–';

          // ç»˜åˆ¶æ³¢çº¹æ•ˆæœ
          const x = plateConfig.offsetX + pos.col * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;
          const y = plateConfig.offsetY + pos.row * (plateConfig.wellSize + plateConfig.gap) + plateConfig.wellSize / 2;

          // åˆ›å»ºæ³¢çº¹å…ƒç´ 
          const ripple = document.createElement('div');
          ripple.style.cssText = `
            position: fixed;
            left: ${canvas.getBoundingClientRect().left + x * scale}px;
            top: ${canvas.getBoundingClientRect().top + y * scale}px;
            width: ${plateConfig.wellSize * scale}px;
            height: ${plateConfig.wellSize * scale}px;
            border-radius: 50%;
            background: rgba(103, 194, 58, 0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
          `;
          document.body.appendChild(ripple);

          // åŠ¨ç”»
          ripple.animate([
            { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
            { transform: 'translate(-50%, -50%) scale(1.5)', opacity: 0 }
          ], {
            duration: 600,
            easing: 'ease-out'
          }).onfinish = () => {
            document.body.removeChild(ripple);
          };

          // é‡ç»˜æ¿ä½å›¾
          drawPlate();

          // æœ€åä¸€ä¸ªå­”ä½å¡«å……å®Œæˆ
          if (index === positions.length - 1) {
            setTimeout(() => {
              showMessage(`æˆåŠŸå¡«å……96ä¸ªå­”ä½! æ¿å·: ${plateNumber}`, 'success');

              // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
              document.querySelector('.stat-card:first-child .stat-value').textContent = '96';
              document.querySelector('.stat-card:last-child .stat-value').textContent = '0';
            }, 100);
          }
        }, delay);

        delay += 30; // æ¯ä¸ªå­”ä½å»¶è¿Ÿ30msï¼Œæ€»å…±çº¦3ç§’å®Œæˆ
      });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initPlateData();
      drawPlate();
    });
  </script>
</body>
</html>
