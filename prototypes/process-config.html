<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµç¨‹é…ç½® - ArkOne æµ‹åºæµç¨‹é…ç½®ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .process-layout {
      display: grid;
      grid-template-columns: 200px 1fr 320px;
      gap: 16px;
      height: calc(100vh - 200px);
    }

    .toolbar {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .toolbar-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .tool-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      border: 2px dashed var(--border-color);
      border-radius: 4px;
      cursor: move;
      transition: all 0.3s;
      user-select: none;
    }

    .tool-item:hover {
      border-color: var(--primary-color);
      background: #F0F9FF;
    }

    .tool-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .tool-label {
      font-size: 12px;
      color: var(--text-regular);
    }

    .canvas-area {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: auto;
      position: relative;
    }

    #processCanvas {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: #FAFAFA;
      cursor: grab;
    }

    #processCanvas:active {
      cursor: grabbing;
    }

    .properties-panel {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .process-node {
      position: absolute;
      padding: 12px 20px;
      background: white;
      border: 2px solid var(--primary-color);
      border-radius: 8px;
      cursor: move;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .process-node:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .process-node.selected {
      border-color: var(--success-color);
      box-shadow: 0 0 0 3px rgba(103, 194, 58, 0.2);
    }

    .process-node.start {
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--success-color);
      color: white;
      font-weight: 600;
    }

    .process-node.end {
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--danger-color);
      color: white;
      font-weight: 600;
    }

    .process-node.gateway {
      width: 80px;
      height: 80px;
      background: var(--warning-color);
      color: white;
      transform: rotate(45deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .process-node.gateway span {
      transform: rotate(-45deg);
    }

    .node-connector {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
      cursor: crosshair;
    }

    .field-list {
      margin-top: 16px;
    }

    .field-item {
      background: var(--bg-color);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-info {
      flex: 1;
    }

    .field-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .field-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .field-actions {
      display: flex;
      gap: 4px;
    }

    .mini-canvas {
      width: 100%;
      height: 200px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: #FAFAFA;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <div>
        <a href="index.html" class="btn btn-text">â† è¿”å›é¦–é¡µ</a>
        <h1 class="page-title">æµç¨‹é…ç½®</h1>
      </div>
      <div class="btn-group">
        <button class="btn btn-default" onclick="handleSaveDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
        <button class="btn btn-default" onclick="handlePreview()">ğŸ‘ï¸ é¢„è§ˆ</button>
        <button class="btn btn-primary" onclick="handlePublish()">ğŸš€ å‘å¸ƒ</button>
      </div>
    </div>

    <div class="process-layout">
      <!-- å·¥å…·æ  -->
      <div class="toolbar">
        <div class="toolbar-title">èŠ‚ç‚¹ç±»å‹</div>

        <div class="tool-item" draggable="true" data-type="start">
          <div class="tool-icon">â­•</div>
          <div class="tool-label">å¼€å§‹</div>
        </div>

        <div class="tool-item" draggable="true" data-type="task">
          <div class="tool-icon">ğŸ“‹</div>
          <div class="tool-label">ä»»åŠ¡</div>
        </div>

        <div class="tool-item" draggable="true" data-type="gateway">
          <div class="tool-icon">â—‡</div>
          <div class="tool-label">ç½‘å…³</div>
        </div>

        <div class="tool-item" draggable="true" data-type="end">
          <div class="tool-icon">â¹ï¸</div>
          <div class="tool-label">ç»“æŸ</div>
        </div>

        <div class="toolbar-title" style="margin-top: 24px;">æµç¨‹æ¨¡æ¿</div>

        <button class="btn btn-default" onclick="loadTemplate('plasmid')" style="width: 100%; margin-bottom: 8px;">
          å…¨è´¨ç²’æµ‹åº
        </button>
        <button class="btn btn-default" onclick="loadTemplate('pcr')" style="width: 100%;">
          PCRäº§ç‰©æµ‹åº
        </button>
      </div>

      <!-- ç”»å¸ƒåŒºåŸŸ -->
      <div class="canvas-area">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <input type="text" class="form-input" placeholder="æµç¨‹åç§°" value="å…¨è´¨ç²’æµ‹åºæµç¨‹" style="width: 300px;">
          </div>
          <div class="btn-group">
            <button class="btn btn-text" onclick="handleZoomIn()">ğŸ”+</button>
            <button class="btn btn-text" onclick="handleZoomOut()">ğŸ”-</button>
            <button class="btn btn-text" onclick="handleFitView()">â›¶</button>
            <button class="btn btn-text" onclick="handleClear()">ğŸ—‘ï¸</button>
          </div>
        </div>

        <canvas id="processCanvas" width="900" height="600"></canvas>
      </div>

      <!-- å±æ€§é¢æ¿ -->
      <div class="properties-panel">
        <div class="panel-title">èŠ‚ç‚¹å±æ€§</div>

        <div id="nodeProperties">
          <div style="text-align: center; padding: 40px 0; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
            <p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
          </div>
        </div>

        <div id="nodePropertiesForm" style="display: none;">
          <div class="form-item">
            <label class="form-label required">èŠ‚ç‚¹åç§°</label>
            <input type="text" class="form-input" id="nodeName" placeholder="è¯·è¾“å…¥èŠ‚ç‚¹åç§°">
          </div>

          <div class="form-item">
            <label class="form-label">èŠ‚ç‚¹ç±»å‹</label>
            <select class="form-select" id="nodeType">
              <option value="userTask">ç”¨æˆ·ä»»åŠ¡</option>
              <option value="serviceTask">æœåŠ¡ä»»åŠ¡</option>
              <option value="scriptTask">è„šæœ¬ä»»åŠ¡</option>
            </select>
          </div>

          <div class="form-item">
            <label class="form-label">è´Ÿè´£äºº</label>
            <select class="form-select" id="assignee">
              <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
              <option value="tech">æŠ€æœ¯äººå‘˜ç»„</option>
              <option value="qa">è´¨é‡è´Ÿè´£äºº</option>
              <option value="manager">é¡¹ç›®ç»ç†</option>
            </select>
          </div>

          <div class="form-item">
            <label class="form-label">è¶…æ—¶è®¾ç½®</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="number" class="form-input" id="timeout" value="24" style="flex: 1;">
              <span>å°æ—¶</span>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">æè¿°</label>
            <textarea class="form-textarea" id="nodeDescription" placeholder="è¯·è¾“å…¥èŠ‚ç‚¹æè¿°"></textarea>
          </div>

          <button class="btn btn-primary" onclick="handleConfigFields()" style="width: 100%; margin-top: 16px;">
            âš™ï¸ é…ç½®å­—æ®µ
          </button>

          <div class="panel-title" style="margin-top: 24px;">å­—æ®µé…ç½®</div>

          <div class="field-list">
            <div class="field-item">
              <div class="field-info">
                <div class="field-name">æ ¸é…¸æµ“åº¦</div>
                <div class="field-meta">ç±»å‹: æ•°å­— | å•ä½: ng/Î¼L | å¿…å¡«</div>
              </div>
              <div class="field-actions">
                <button class="btn btn-text">âœï¸</button>
                <button class="btn btn-text">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div class="field-item">
              <div class="field-info">
                <div class="field-name">è¡¥ddHâ‚‚O</div>
                <div class="field-meta">ç±»å‹: æ•°å­— | å•ä½: Î¼L | å¯é€‰</div>
              </div>
              <div class="field-actions">
                <button class="btn btn-text">âœï¸</button>
                <button class="btn btn-text">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>

          <button class="btn btn-default" onclick="handleAddField()" style="width: 100%; margin-top: 12px;">
            â• æ·»åŠ å­—æ®µ
          </button>
        </div>

        <div class="panel-title" style="margin-top: 24px;">æµç¨‹é¢„è§ˆ</div>
        <canvas class="mini-canvas" id="miniCanvas"></canvas>
      </div>
    </div>
  </div>

  <script src="scripts.js"></script>
  <script>
    const canvas = document.getElementById('processCanvas');
    const ctx = canvas.getContext('2d');
    const miniCanvas = document.getElementById('miniCanvas');
    const miniCtx = miniCanvas.getContext('2d');

    let nodes = [];
    let connections = [];
    let selectedNode = null;
    let scale = 1;
    let offset = { x: 0, y: 0 };

    // åˆå§‹åŒ–ç¤ºä¾‹æµç¨‹
    function initSampleProcess() {
      nodes = [
        { id: 1, type: 'start', x: 100, y: 100, label: 'å¼€å§‹' },
        { id: 2, type: 'task', x: 100, y: 200, label: 'æ ·æœ¬ç™»è®°', width: 120, height: 60 },
        { id: 3, type: 'gateway', x: 100, y: 320, label: 'æ ·æœ¬ç±»å‹?', width: 80, height: 80 },
        { id: 4, type: 'task', x: 50, y: 450, label: 'æ‘‡èŒ', width: 100, height: 60 },
        { id: 5, type: 'task', x: 200, y: 450, label: 'æ ¸é…¸æå–', width: 100, height: 60 },
        { id: 6, type: 'task', x: 350, y: 450, label: 'æ ·æœ¬å‰å¤„ç†', width: 120, height: 60 },
        { id: 7, type: 'end', x: 200, y: 550, label: 'ç»“æŸ' }
      ];

      connections = [
        { from: 1, to: 2 },
        { from: 2, to: 3 },
        { from: 3, to: 4, label: 'å¹³æ¿' },
        { from: 3, to: 5, label: 'ç›´æŠ½' },
        { from: 3, to: 6, label: 'è´¨ç²’' },
        { from: 4, to: 7 },
        { from: 5, to: 7 },
        { from: 6, to: 7 }
      ];

      drawProcess();
      drawMiniMap();
    }

    // ç»˜åˆ¶æµç¨‹
    function drawProcess() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.translate(offset.x, offset.y);
      ctx.scale(scale, scale);

      // ç»˜åˆ¶è¿æ¥çº¿
      ctx.strokeStyle = '#909399';
      ctx.lineWidth = 2;
      connections.forEach(conn => {
        const fromNode = nodes.find(n => n.id === conn.from);
        const toNode = nodes.find(n => n.id === conn.to);

        if (fromNode && toNode) {
          ctx.beginPath();
          ctx.moveTo(fromNode.x, fromNode.y);
          ctx.lineTo(toNode.x, toNode.y);
          ctx.stroke();

          // ç»˜åˆ¶ç®­å¤´
          const angle = Math.atan2(toNode.y - fromNode.y, toNode.x - fromNode.x);
          const arrowSize = 10;
          ctx.beginPath();
          ctx.moveTo(toNode.x, toNode.y);
          ctx.lineTo(
            toNode.x - arrowSize * Math.cos(angle - Math.PI / 6),
            toNode.y - arrowSize * Math.sin(angle - Math.PI / 6)
          );
          ctx.lineTo(
            toNode.x - arrowSize * Math.cos(angle + Math.PI / 6),
            toNode.y - arrowSize * Math.sin(angle + Math.PI / 6)
          );
          ctx.closePath();
          ctx.fillStyle = '#909399';
          ctx.fill();

          // ç»˜åˆ¶æ ‡ç­¾
          if (conn.label) {
            const midX = (fromNode.x + toNode.x) / 2;
            const midY = (fromNode.y + toNode.y) / 2;
            ctx.fillStyle = '#606266';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(conn.label, midX, midY - 5);
          }
        }
      });

      // ç»˜åˆ¶èŠ‚ç‚¹
      nodes.forEach(node => {
        if (node.type === 'start') {
          ctx.beginPath();
          ctx.arc(node.x, node.y, 30, 0, Math.PI * 2);
          ctx.fillStyle = selectedNode === node ? '#85CE61' : '#67C23A';
          ctx.fill();
          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 3;
          ctx.stroke();

          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(node.label, node.x, node.y);
        } else if (node.type === 'end') {
          ctx.beginPath();
          ctx.arc(node.x, node.y, 30, 0, Math.PI * 2);
          ctx.fillStyle = selectedNode === node ? '#F78989' : '#F56C6C';
          ctx.fill();
          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 3;
          ctx.stroke();

          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(node.label, node.x, node.y);
        } else if (node.type === 'gateway') {
          ctx.save();
          ctx.translate(node.x, node.y);
          ctx.rotate(Math.PI / 4);

          ctx.fillStyle = selectedNode === node ? '#F0C78A' : '#E6A23C';
          ctx.fillRect(-40, -40, 80, 80);

          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 3;
          ctx.strokeRect(-40, -40, 80, 80);

          ctx.restore();

          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 12px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(node.label, node.x, node.y);
        } else {
          const width = node.width || 120;
          const height = node.height || 60;

          ctx.fillStyle = selectedNode === node ? '#A0CFFF' : '#409EFF';
          ctx.fillRect(node.x - width / 2, node.y - height / 2, width, height);

          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 3;
          ctx.strokeRect(node.x - width / 2, node.y - height / 2, width, height);

          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(node.label, node.x, node.y);
        }
      });

      ctx.restore();
    }

    // ç»˜åˆ¶ç¼©ç•¥å›¾
    function drawMiniMap() {
      const scale = 0.2;
      miniCtx.clearRect(0, 0, miniCanvas.width, miniCanvas.height);

      miniCtx.save();
      miniCtx.scale(scale, scale);

      // ç»˜åˆ¶è¿æ¥çº¿
      miniCtx.strokeStyle = '#DCDFE6';
      miniCtx.lineWidth = 2;
      connections.forEach(conn => {
        const fromNode = nodes.find(n => n.id === conn.from);
        const toNode = nodes.find(n => n.id === conn.to);

        if (fromNode && toNode) {
          miniCtx.beginPath();
          miniCtx.moveTo(fromNode.x, fromNode.y);
          miniCtx.lineTo(toNode.x, toNode.y);
          miniCtx.stroke();
        }
      });

      // ç»˜åˆ¶èŠ‚ç‚¹
      nodes.forEach(node => {
        if (node.type === 'start' || node.type === 'end') {
          miniCtx.beginPath();
          miniCtx.arc(node.x, node.y, 15, 0, Math.PI * 2);
          miniCtx.fillStyle = node.type === 'start' ? '#67C23A' : '#F56C6C';
          miniCtx.fill();
        } else if (node.type === 'gateway') {
          miniCtx.save();
          miniCtx.translate(node.x, node.y);
          miniCtx.rotate(Math.PI / 4);
          miniCtx.fillStyle = '#E6A23C';
          miniCtx.fillRect(-20, -20, 40, 40);
          miniCtx.restore();
        } else {
          const width = (node.width || 120) / 2;
          const height = (node.height || 60) / 2;
          miniCtx.fillStyle = '#409EFF';
          miniCtx.fillRect(node.x - width / 2, node.y - height / 2, width, height);
        }
      });

      miniCtx.restore();
    }

    // ç‚¹å‡»èŠ‚ç‚¹
    canvas.addEventListener('click', (event) => {
      const rect = canvas.getBoundingClientRect();
      const x = (event.clientX - rect.left - offset.x) / scale;
      const y = (event.clientY - rect.top - offset.y) / scale;

      selectedNode = null;

      for (let node of nodes) {
        let hit = false;

        if (node.type === 'start' || node.type === 'end') {
          const distance = Math.sqrt((x - node.x) ** 2 + (y - node.y) ** 2);
          hit = distance <= 30;
        } else if (node.type === 'gateway') {
          hit = Math.abs(x - node.x) <= 40 && Math.abs(y - node.y) <= 40;
        } else {
          const width = node.width || 120;
          const height = node.height || 60;
          hit = x >= node.x - width / 2 && x <= node.x + width / 2 &&
                y >= node.y - height / 2 && y <= node.y + height / 2;
        }

        if (hit) {
          selectedNode = node;
          showNodeProperties(node);
          break;
        }
      }

      drawProcess();
    });

    // æ˜¾ç¤ºèŠ‚ç‚¹å±æ€§
    function showNodeProperties(node) {
      document.getElementById('nodeProperties').style.display = 'none';
      document.getElementById('nodePropertiesForm').style.display = 'block';
      document.getElementById('nodeName').value = node.label;
    }

    // åŠ è½½æ¨¡æ¿
    function loadTemplate(type) {
      if (type === 'plasmid') {
        showMessage('å·²åŠ è½½å…¨è´¨ç²’æµ‹åºæµç¨‹æ¨¡æ¿', 'success');
        initSampleProcess();
      } else {
        showMessage('å·²åŠ è½½PCRäº§ç‰©æµ‹åºæµç¨‹æ¨¡æ¿', 'success');
      }
    }

    // æ”¾å¤§
    function handleZoomIn() {
      scale = Math.min(scale + 0.1, 2);
      drawProcess();
    }

    // ç¼©å°
    function handleZoomOut() {
      scale = Math.max(scale - 0.1, 0.5);
      drawProcess();
    }

    // é€‚åº”è§†å›¾
    function handleFitView() {
      scale = 1;
      offset = { x: 0, y: 0 };
      drawProcess();
    }

    // æ¸…ç©º
    function handleClear() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ')) {
        nodes = [];
        connections = [];
        selectedNode = null;
        drawProcess();
        drawMiniMap();
      }
    }

    // ä¿å­˜è‰ç¨¿
    function handleSaveDraft() {
      showMessage('æµç¨‹è‰ç¨¿å·²ä¿å­˜', 'success');
    }

    // é¢„è§ˆ
    function handlePreview() {
      showMessage('é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // å‘å¸ƒ
    function handlePublish() {
      if (confirm('ç¡®å®šè¦å‘å¸ƒæ­¤æµç¨‹å—ï¼Ÿå‘å¸ƒåå°†ç«‹å³ç”Ÿæ•ˆã€‚')) {
        showMessage('æµç¨‹å‘å¸ƒæˆåŠŸ!', 'success');
      }
    }

    // é…ç½®å­—æ®µ
    function handleConfigFields() {
      showMessage('å­—æ®µé…ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // æ·»åŠ å­—æ®µ
    function handleAddField() {
      showMessage('æ·»åŠ å­—æ®µåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initSampleProcess();
    });
  </script>
</body>
</html>
