<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡æ•°æ®å½•å…¥ - ArkOne æµ‹åºæµç¨‹é…ç½®ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .batch-toolbar {
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
    }

    .toolbar-right {
      display: flex;
      gap: 8px;
    }

    .progress-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-color);
      border-radius: 4px;
    }

    .progress-text {
      font-size: 14px;
      color: var(--text-regular);
    }

    .progress-number {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-input {
      width: 200px;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    .batch-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 320px);
    }

    .batch-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    .batch-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-color);
    }

    .batch-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      color: var(--text-regular);
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
      background: var(--bg-color);
    }

    .batch-table th.sticky-col {
      position: sticky;
      left: 0;
      z-index: 11;
      background: var(--bg-color);
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
    }

    .batch-table td {
      padding: 8px;
      border-bottom: 1px solid #EBEEF5;
      text-align: center;
    }

    .batch-table td.sticky-col {
      position: sticky;
      left: 0;
      background: white;
      z-index: 5;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
    }

    .batch-table tbody tr:hover td {
      background: var(--bg-color);
    }

    .batch-table tbody tr:hover td.sticky-col {
      background: #F0F9FF;
    }

    .batch-table tbody tr.has-error {
      background: #FEF0F0;
    }

    .batch-table tbody tr.completed {
      background: #F0F9FF;
    }

    .cell-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
      transition: all 0.3s;
    }

    .cell-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
    }

    .cell-input.error {
      border-color: var(--danger-color);
      background: #FEF0F0;
    }

    .cell-input.success {
      border-color: var(--success-color);
      background: #F0F9FF;
    }

    .cell-input:disabled {
      background: var(--bg-color);
      cursor: not-allowed;
    }

    .sample-id-cell {
      font-weight: 600;
      color: var(--primary-color);
      white-space: nowrap;
    }

    .position-cell {
      font-weight: 500;
      color: var(--text-regular);
    }

    .error-tooltip {
      position: absolute;
      background: var(--danger-color);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .cell-input.error:focus + .error-tooltip {
      opacity: 1;
    }

    .paste-hint {
      background: #F0F9FF;
      border: 2px dashed var(--primary-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }

    .paste-hint-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .paste-hint-text {
      font-size: 14px;
      color: var(--text-regular);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .icon-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s;
      border-radius: 4px;
    }

    .icon-btn:hover {
      background: var(--bg-color);
      color: var(--primary-color);
    }

    @keyframes ripple {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .success-ripple {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--success-color);
      animation: ripple 0.6s ease-out;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <div>
        <a href="sample-detail.html" class="btn btn-text">â† è¿”å›è¯¦æƒ…</a>
        <h1 class="page-title">æ‰¹é‡æ•°æ®å½•å…¥ - æ ·æœ¬å‰å¤„ç†</h1>
      </div>
      <div class="btn-group">
        <button class="btn btn-text" onclick="window.location.href='data-entry.html'">â† åˆ‡æ¢åˆ°å•ä¸ªå½•å…¥</button>
        <button class="btn btn-default" onclick="handleSaveDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
        <button class="btn btn-default" onclick="handleClearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn btn-default" onclick="handleExportExcel()">ğŸ“¤ å¯¼å‡ºExcel</button>
        <button class="btn btn-primary" onclick="handleBatchSubmit()">âœ“ æ‰¹é‡æäº¤</button>
      </div>
    </div>

    <!-- ç²˜è´´æç¤º -->
    <div class="paste-hint">
      <div class="paste-hint-title">ğŸ’¡ å¿«é€Ÿå½•å…¥æç¤º</div>
      <div class="paste-hint-text">
        æ”¯æŒä»Excelå¤åˆ¶ç²˜è´´æ•°æ® (Ctrl+V) | æŒ‰Tabé”®å¿«é€Ÿåˆ‡æ¢å•å…ƒæ ¼ | æŒ‰Enteré”®è·³åˆ°ä¸‹ä¸€è¡Œ | æ”¯æŒæ‰¹é‡å¡«å……ç›¸åŒæ•°æ®
      </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="batch-toolbar">
      <div class="toolbar-left">
        <div class="progress-info">
          <span class="progress-text">å½•å…¥è¿›åº¦:</span>
          <span class="progress-number" id="progressText">0/96</span>
        </div>
        <div class="search-box">
          <input
            type="text"
            class="search-input"
            placeholder="æœç´¢æ ·æœ¬IDæˆ–å­”ä½..."
            id="searchInput"
            oninput="handleSearch()"
          >
          <button class="btn btn-text" onclick="handleSearch()">ğŸ”</button>
        </div>
      </div>
      <div class="toolbar-right">
        <button class="btn btn-default" onclick="handleAutoFill()">âš¡ æ™ºèƒ½å¡«å……</button>
        <button class="btn btn-default" onclick="handleValidateAll()">âœ“ éªŒè¯å…¨éƒ¨</button>
      </div>
    </div>

    <!-- æ‰¹é‡æ•°æ®è¡¨æ ¼ -->
    <div class="batch-table-container">
      <div class="table-wrapper">
        <table class="batch-table" id="batchTable">
          <thead>
            <tr>
              <th class="sticky-col" style="width: 40px;">åºå·</th>
              <th class="sticky-col" style="width: 140px; left: 40px;">æ ·æœ¬ID</th>
              <th style="width: 80px;">å­”ä½</th>
              <th style="width: 120px;">æ ¸é…¸æµ“åº¦<br><small>(ng/Î¼L)</small></th>
              <th style="width: 120px;">è¡¥ddHâ‚‚O<br><small>(Î¼L)</small></th>
              <th style="width: 120px;">OD260/280</th>
              <th style="width: 120px;">OD260/230</th>
              <th style="width: 120px;">æ“ä½œäºº</th>
              <th style="width: 160px;">æ“ä½œæ—¶é—´</th>
              <th style="width: 200px;">å¤‡æ³¨</th>
              <th style="width: 100px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- åŠ¨æ€ç”Ÿæˆ96è¡Œ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="scripts.js"></script>
  <script>
    // ç”Ÿæˆ96ä¸ªæ ·æœ¬æ•°æ®
    const samples = [];
    const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
    const operators = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­'];

    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 12; c++) {
        const position = `${rows[r]}${String(c + 1).padStart(2, '0')}`;
        samples.push({
          index: r * 12 + c + 1,
          sampleId: `AK20260224${String(r * 12 + c + 1).padStart(3, '0')}`,
          position: position,
          concentration: '',
          waterVolume: '',
          od260280: '',
          od260230: '',
          operator: '',
          operationTime: '',
          remark: '',
          errors: {}
        });
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      samples.forEach((sample, index) => {
        const tr = document.createElement('tr');
        tr.id = `row-${index}`;
        tr.className = sample.completed ? 'completed' : '';

        tr.innerHTML = `
          <td class="sticky-col">${sample.index}</td>
          <td class="sticky-col sample-id-cell" style="left: 40px;">${sample.sampleId}</td>
          <td class="position-cell">${sample.position}</td>
          <td>
            <input
              type="number"
              class="cell-input"
              data-field="concentration"
              data-index="${index}"
              value="${sample.concentration}"
              placeholder="0-1000"
              min="0"
              max="1000"
              step="0.01"
              oninput="handleCellInput(${index}, 'concentration', this.value)"
              onblur="validateCell(${index}, 'concentration')"
            >
          </td>
          <td>
            <input
              type="number"
              class="cell-input"
              data-field="waterVolume"
              data-index="${index}"
              value="${sample.waterVolume}"
              disabled
              placeholder="è‡ªåŠ¨è®¡ç®—"
            >
          </td>
          <td>
            <input
              type="number"
              class="cell-input"
              data-field="od260280"
              data-index="${index}"
              value="${sample.od260280}"
              placeholder="1.6-2.2"
              min="1.6"
              max="2.2"
              step="0.01"
              oninput="handleCellInput(${index}, 'od260280', this.value)"
              onblur="validateCell(${index}, 'od260280')"
            >
          </td>
          <td>
            <input
              type="number"
              class="cell-input"
              data-field="od260230"
              data-index="${index}"
              value="${sample.od260230}"
              placeholder="1.8-2.5"
              min="1.8"
              max="2.5"
              step="0.01"
              oninput="handleCellInput(${index}, 'od260230', this.value)"
              onblur="validateCell(${index}, 'od260230')"
            >
          </td>
          <td>
            <select
              class="cell-input"
              data-field="operator"
              data-index="${index}"
              onchange="handleCellInput(${index}, 'operator', this.value)"
            >
              <option value="">è¯·é€‰æ‹©</option>
              ${operators.map(op => `<option value="${op}" ${sample.operator === op ? 'selected' : ''}>${op}</option>`).join('')}
            </select>
          </td>
          <td>
            <input
              type="datetime-local"
              class="cell-input"
              data-field="operationTime"
              data-index="${index}"
              value="${sample.operationTime}"
              oninput="handleCellInput(${index}, 'operationTime', this.value)"
            >
          </td>
          <td>
            <input
              type="text"
              class="cell-input"
              data-field="remark"
              data-index="${index}"
              value="${sample.remark}"
              placeholder="å¤‡æ³¨"
              oninput="handleCellInput(${index}, 'remark', this.value)"
            >
          </td>
          <td>
            <div class="action-buttons">
              <button class="icon-btn" onclick="handleCopyRow(${index})" title="å¤åˆ¶">ğŸ“‹</button>
              <button class="icon-btn" onclick="handleClearRow(${index})" title="æ¸…ç©º">ğŸ—‘ï¸</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });

      updateProgress();
    }

    // å¤„ç†å•å…ƒæ ¼è¾“å…¥
    function handleCellInput(index, field, value) {
      samples[index][field] = value;

      // è‡ªåŠ¨è®¡ç®—è¡¥æ°´é‡
      if (field === 'concentration' && value) {
        const concentration = parseFloat(value);
        if (!isNaN(concentration) && concentration > 0) {
          const targetConcentration = 50;
          const totalVolume = 100;
          const sampleVolume = (targetConcentration * totalVolume) / concentration;
          const waterVolume = Math.max(0, totalVolume - sampleVolume).toFixed(2);

          samples[index].waterVolume = waterVolume;
          const waterInput = document.querySelector(`input[data-index="${index}"][data-field="waterVolume"]`);
          if (waterInput) {
            waterInput.value = waterVolume;
          }
        }
      }

      updateProgress();
      storage.set('batch_draft', samples);
    }

    // éªŒè¯å•å…ƒæ ¼
    function validateCell(index, field) {
      const sample = samples[index];
      const input = document.querySelector(`input[data-index="${index}"][data-field="${field}"]`);

      if (!input) return;

      let isValid = true;
      let errorMsg = '';

      const value = parseFloat(sample[field]);

      if (field === 'concentration') {
        if (sample[field] && (isNaN(value) || value < 0 || value > 1000)) {
          isValid = false;
          errorMsg = 'æµ“åº¦èŒƒå›´: 0-1000';
        }
      } else if (field === 'od260280') {
        if (sample[field] && (isNaN(value) || value < 1.6 || value > 2.2)) {
          isValid = false;
          errorMsg = 'èŒƒå›´: 1.6-2.2';
        }
      } else if (field === 'od260230') {
        if (sample[field] && (isNaN(value) || value < 1.8 || value > 2.5)) {
          isValid = false;
          errorMsg = 'èŒƒå›´: 1.8-2.5';
        }
      }

      if (isValid) {
        input.classList.remove('error');
        input.classList.add('success');
        delete sample.errors[field];
      } else {
        input.classList.remove('success');
        input.classList.add('error');
        sample.errors[field] = errorMsg;
        input.title = errorMsg;
      }

      updateRowStatus(index);
    }

    // æ›´æ–°è¡ŒçŠ¶æ€
    function updateRowStatus(index) {
      const row = document.getElementById(`row-${index}`);
      const sample = samples[index];

      if (Object.keys(sample.errors).length > 0) {
        row.classList.add('has-error');
        row.classList.remove('completed');
      } else if (sample.concentration && sample.operator && sample.operationTime) {
        row.classList.add('completed');
        row.classList.remove('has-error');
        sample.completed = true;
      } else {
        row.classList.remove('has-error', 'completed');
        sample.completed = false;
      }
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress() {
      const completed = samples.filter(s => s.completed).length;
      document.getElementById('progressText').textContent = `${completed}/96`;
    }

    // æœç´¢
    function handleSearch() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();

      samples.forEach((sample, index) => {
        const row = document.getElementById(`row-${index}`);
        const match = sample.sampleId.toLowerCase().includes(keyword) ||
                     sample.position.toLowerCase().includes(keyword);

        if (match || !keyword) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      if (keyword) {
        const firstMatch = samples.findIndex(s =>
          s.sampleId.toLowerCase().includes(keyword) ||
          s.position.toLowerCase().includes(keyword)
        );

        if (firstMatch >= 0) {
          const row = document.getElementById(`row-${firstMatch}`);
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    // æ™ºèƒ½å¡«å……
    function handleAutoFill() {
      const now = new Date();
      const timeString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      samples.forEach((sample, index) => {
        if (!sample.operationTime) {
          sample.operationTime = timeString;
        }
        if (!sample.operator) {
          sample.operator = 'æå››';
        }
      });

      renderTable();
      showMessage('å·²è‡ªåŠ¨å¡«å……æ“ä½œäººå’Œæ“ä½œæ—¶é—´', 'success');
    }

    // éªŒè¯å…¨éƒ¨
    function handleValidateAll() {
      let errorCount = 0;

      samples.forEach((sample, index) => {
        validateCell(index, 'concentration');
        validateCell(index, 'od260280');
        validateCell(index, 'od260230');

        if (Object.keys(sample.errors).length > 0) {
          errorCount++;
        }
      });

      if (errorCount === 0) {
        showMessage('å…¨éƒ¨æ•°æ®éªŒè¯é€šè¿‡!', 'success');
      } else {
        showMessage(`å‘ç° ${errorCount} ä¸ªæ ·æœ¬å­˜åœ¨é”™è¯¯ï¼Œè¯·ä¿®æ­£`, 'error');
      }
    }

    // å¤åˆ¶è¡Œ
    function handleCopyRow(index) {
      const sample = samples[index];
      const data = {
        concentration: sample.concentration,
        od260280: sample.od260280,
        od260230: sample.od260230,
        operator: sample.operator,
        operationTime: sample.operationTime,
        remark: sample.remark
      };

      storage.set('copied_row', data);
      showMessage('å·²å¤åˆ¶è¡Œæ•°æ®ï¼Œå¯ç²˜è´´åˆ°å…¶ä»–è¡Œ', 'success');
    }

    // æ¸…ç©ºè¡Œ
    function handleClearRow(index) {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè¿™ä¸€è¡Œçš„æ•°æ®å—?')) {
        samples[index].concentration = '';
        samples[index].waterVolume = '';
        samples[index].od260280 = '';
        samples[index].od260230 = '';
        samples[index].operator = '';
        samples[index].operationTime = '';
        samples[index].remark = '';
        samples[index].errors = {};
        samples[index].completed = false;

        renderTable();
        showMessage('å·²æ¸…ç©ºè¡Œæ•°æ®', 'info');
      }
    }

    // ä¿å­˜è‰ç¨¿
    function handleSaveDraft() {
      storage.set('batch_draft', samples);
      showMessage('è‰ç¨¿å·²ä¿å­˜', 'success');
    }

    // æ¸…ç©ºå…¨éƒ¨
    function handleClearAll() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—? æ­¤æ“ä½œä¸å¯æ¢å¤!')) {
        samples.forEach(sample => {
          sample.concentration = '';
          sample.waterVolume = '';
          sample.od260280 = '';
          sample.od260230 = '';
          sample.operator = '';
          sample.operationTime = '';
          sample.remark = '';
          sample.errors = {};
          sample.completed = false;
        });

        renderTable();
        storage.remove('batch_draft');
        showMessage('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'info');
      }
    }

    // å¯¼å‡ºExcel
    function handleExportExcel() {
      showMessage('æ­£åœ¨å¯¼å‡ºExcel...', 'info');

      setTimeout(() => {
        const data = samples.map(s => ({
          'åºå·': s.index,
          'æ ·æœ¬ID': s.sampleId,
          'å­”ä½': s.position,
          'æ ¸é…¸æµ“åº¦': s.concentration,
          'è¡¥ddHâ‚‚O': s.waterVolume,
          'OD260/280': s.od260280,
          'OD260/230': s.od260230,
          'æ“ä½œäºº': s.operator,
          'æ“ä½œæ—¶é—´': s.operationTime,
          'å¤‡æ³¨': s.remark
        }));

        console.log('å¯¼å‡ºæ•°æ®:', data);
        showMessage('Excelå¯¼å‡ºæˆåŠŸ!', 'success');
      }, 1000);
    }

    // æ‰¹é‡æäº¤
    function handleBatchSubmit() {
      // éªŒè¯å¿…å¡«å­—æ®µ
      const incomplete = samples.filter(s => !s.concentration || !s.operator || !s.operationTime);
      const hasErrors = samples.filter(s => Object.keys(s.errors).length > 0);

      if (hasErrors.length > 0) {
        showMessage(`å‘ç° ${hasErrors.length} ä¸ªæ ·æœ¬å­˜åœ¨é”™è¯¯ï¼Œè¯·å…ˆä¿®æ­£`, 'error');
        return;
      }

      if (incomplete.length > 0) {
        if (!confirm(`è¿˜æœ‰ ${incomplete.length} ä¸ªæ ·æœ¬æœªå®Œæˆå½•å…¥ï¼Œç¡®å®šè¦æäº¤å—?`)) {
          return;
        }
      }

      showMessage('æ­£åœ¨æ‰¹é‡æäº¤æ•°æ®...', 'info');

      setTimeout(() => {
        storage.remove('batch_draft');
        showMessage('æ‰¹é‡æäº¤æˆåŠŸ! 96ä¸ªæ ·æœ¬æ•°æ®å·²ä¿å­˜', 'success');

        setTimeout(() => {
          window.location.href = 'sample-list.html';
        }, 1500);
      }, 1500);
    }

    // é”®ç›˜å¯¼èˆª
    document.addEventListener('keydown', (e) => {
      const activeElement = document.activeElement;

      if (activeElement.classList.contains('cell-input')) {
        const index = parseInt(activeElement.dataset.index);
        const field = activeElement.dataset.field;

        if (e.key === 'Tab' && !e.shiftKey) {
          e.preventDefault();
          // è·³åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
          const nextInput = activeElement.closest('td').nextElementSibling?.querySelector('.cell-input');
          if (nextInput && !nextInput.disabled) {
            nextInput.focus();
            nextInput.select();
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          // è·³åˆ°ä¸‹ä¸€è¡Œç›¸åŒå­—æ®µ
          const nextRow = document.getElementById(`row-${index + 1}`);
          if (nextRow) {
            const nextInput = nextRow.querySelector(`[data-field="${field}"]`);
            if (nextInput && !nextInput.disabled) {
              nextInput.focus();
              nextInput.select();
            }
          }
        }
      }
    });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // æ¢å¤è‰ç¨¿
      const draft = storage.get('batch_draft');
      if (draft && draft.length === 96) {
        if (confirm('æ£€æµ‹åˆ°æœªä¿å­˜çš„è‰ç¨¿ï¼Œæ˜¯å¦æ¢å¤?')) {
          draft.forEach((d, i) => {
            Object.assign(samples[i], d);
          });
          showMessage('è‰ç¨¿å·²æ¢å¤', 'info');
        }
      }

      renderTable();
    });
  </script>
</body>
</html>
