# ArkOne 测序流程配置系统 - 需求对齐会议纪要

**会议时间**: 2026-02-24
**会议类型**: 跨职能需求对齐与技术审查
**参与角色**: 业务分析师、产品经理、架构师、后端开发、前端开发
**会议目标**: 审查现有文档,识别问题和风险,确保需求理解一致

---

## 一、会议总结

### 1.1 整体评估

经过5个专业角色的全面审查,项目文档质量整体良好,但存在若干需要澄清和完善的关键问题。

| 评估维度 | 评分 (1-10) | 说明 |
|---------|------------|------|
| 业务需求完整性 | 6.0 | 正常流程清晰,异常流程缺失严重 |
| 产品设计完整性 | 7.6 | 基础完整,但缺少MVP定义和用户故事 |
| 架构设计合理性 | 7.5 | 架构清晰,但部分关键细节不足 |
| 后端技术可行性 | 7.5 | 技术栈合理,但API和安全设计有缺陷 |
| 前端技术可行性 | 7.0 | 可实现,但存在高难度技术挑战 |
| **综合评分** | **7.1** | **可以启动,但必须先解决P0问题** |

### 1.2 关键发现

**✅ 优势**:
- 技术栈选型成熟稳定
- 核心业务流程清晰
- 数据模型设计合理
- 部署方案完整

**⚠️ 风险**:
- 异常流程处理缺失(40%场景未覆盖)
- 流程版本管理策略不明确
- 安全设计存在漏洞(AES/ECB、公式注入)
- 前端技术难点需要专门预研
- API接口设计不完整

---

## 二、关键问题汇总(按优先级)

### P0 级别 - 必须在开发前解决

#### 问题1: 样本状态转换与异常处理机制 🔴

**提出者**: 业务分析师、产品经理
**问题描述**:
- 样本在流程节点失败后如何处理?(回退?终止?重新启动?)
- 完整的样本状态列表和转换规则是什么?
- "暂停"、"异常"、"已取消"状态的触发条件和处理流程?
- 数据修正是否需要审批流程?

**影响**: 系统上线后无法应对实际异常情况,可能导致业务中断

**需要回答的人**: 产品经理、业务分析师、实验室用户

---

#### 问题2: Flowable流程实例与业务数据的事务一致性 🔴

**提出者**: 架构师、后端开发
**问题描述**:
```java
@Transactional
public void completeTask(String taskId, Map<String, Object> nodeData) {
    // 1. 保存节点数据到 lims_process_node_data
    processNodeDataMapper.insert(data);  // 已执行

    // 2. 完成Flowable任务
    taskService.complete(taskId, nodeData);  // 如果这里失败?
}
```
- Flowable引擎是否与业务数据库使用同一数据源?
- 如果Flowable任务完成失败,业务数据如何回滚?
- 是否需要引入分布式事务(Saga/TCC)?

**影响**: 可能导致数据不一致,样本状态与流程状态不匹配

**需要回答的人**: 架构师、后端开发

---

#### 问题3: 公式计算引擎的安全风险 🔴

**提出者**: 架构师、后端开发
**问题描述**:
```java
// 当前设计使用JavaScript ScriptEngine
public Object evaluateFormula(String formula, Map<String, Object> context) {
    return scriptEngine.eval(formula, bindings);  // 代码注入风险!
}
```
- 用户配置的公式可能包含恶意代码
- 需要替换为安全的表达式引擎(SpEL、MVEL、Aviator)

**影响**: 严重安全漏洞,可能导致系统被攻击

**需要回答的人**: 架构师、后端开发

---

#### 问题4: 容器转移的业务规则与样本追踪 🔴

**提出者**: 业务分析师、前端开发
**问题描述**:
- 样本从48深孔板转移到96孔板的操作在哪个节点执行?
- 转移操作是否需要单独的流程节点?
- 如何防止转移过程中的样本混淆?(扫码验证?)
- 转移后原容器的孔位状态如何更新?

**影响**: 样本追踪准确率无法达到99.9%的目标

**需要回答的人**: 业务分析师、产品经理

---

#### 问题5: 批量操作的事务处理策略 🔴

**提出者**: 业务分析师、后端开发、前端开发
**问题描述**:
- 批量导入100个样本,其中10个验证失败,是全部失败还是部分成功?
- 批量操作的事务边界如何定义?
- 如何向用户反馈失败的具体原因?
- 批量操作的审计日志如何记录?

**影响**: 用户体验差,数据一致性无法保证

**需要回答的人**: 产品经理、后端开发

---

#### 问题6: 流程版本升级与实例迁移策略 🔴

**提出者**: 架构师、业务分析师、产品经理
**问题描述**:
- 流程定义变更后,正在执行的旧版本流程实例如何处理?
  - 选项A: 继续使用旧版本直到完成
  - 选项B: 自动迁移到新版本
  - 选项C: 人工决定是否迁移
- 历史数据的字段结构与新版本不一致时如何展示?
- 是否需要保留所有历史版本的流程定义?

**影响**: 系统升级后可能导致历史数据无法查询或流程中断

**需要回答的人**: 产品经理、架构师

---

### P1 级别 - 强烈建议在开发前解决

#### 问题7: 容器孔位分配的并发控制

**提出者**: 架构师、后端开发
**问题描述**:
- 当前设计使用"查询-检查-更新"模式,存在竞态条件
- 需要使用数据库唯一约束+乐观锁,或分布式锁(Redis Redisson)

**建议方案**:
```sql
ALTER TABLE lims_sample ADD CONSTRAINT uk_container_position
    UNIQUE (container_id, position) WHERE deleted = FALSE;
```

---

#### 问题8: 样本编号生成的高可用性

**提出者**: 架构师、后端开发
**问题描述**:
- 当前依赖Redis生成序列号,Redis不可用时编号生成会失败
- `%03d`格式只支持999个样本/天,超出后编号会变长

**建议方案**:
- 使用数据库序列+Redis缓存的双重保障
- 或使用雪花算法生成分布式ID

---

#### 问题9: AES加密模式安全性

**提出者**: 架构师、后端开发
**问题描述**:
```java
Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");  // ECB模式不安全
```
- ECB模式对相同明文产生相同密文,容易被模式分析攻击

**建议方案**:
- 使用AES/GCM或AES/CBC模式
- 密钥使用Vault或KMS管理

---

#### 问题10: API接口设计不完整

**提出者**: 前端开发、后端开发
**缺失的接口**:

**流程管理**:
- `GET /process/definitions` - 查询流程定义列表
- `POST /process/definitions` - 部署新流程定义
- `GET /process/definitions/{id}/xml` - 获取流程BPMN XML
- `POST /process/instances/{id}/suspend` - 挂起流程实例

**任务管理**:
- `GET /process/tasks/my` - 查询我的待办任务
- `POST /process/tasks/{id}/claim` - 认领任务
- `POST /process/tasks/{id}/delegate` - 委派任务

**批量操作**:
- `POST /samples/batch` - 批量创建样本
- `PUT /samples/batch/status` - 批量更新状态
- `POST /process/tasks/batch/complete` - 批量完成任务

**数据统计**:
- `GET /statistics/samples/status` - 样本状态统计
- `GET /statistics/process/performance` - 流程性能统计
- `GET /statistics/nodes/duration` - 节点耗时统计

---

#### 问题11: 前端技术难点需要预研

**提出者**: 前端开发
**高难度技术挑战**:

1. **bpmn-js流程设计器定制** (预估3-4周)
   - 深度定制(自定义节点、属性面板、工具栏)
   - 中文化适配
   - 与Flowable引擎的BPMN XML格式对齐
   - 建议: 引入有bpmn-js经验的开发者

2. **动态表单引擎** (预估2-3周)
   - 字段类型动态渲染
   - 复杂验证规则
   - 计算字段的公式解析
   - 建议: 考虑使用form-create或form-render

3. **板位图可视化** (预估1-2周)
   - 96孔板和48深孔板的动态渲染
   - 拖拽分配样本
   - 建议: 使用Canvas或SVG渲染

**建议**: 启动2周技术预研,验证可行性

---

#### 问题12: 数据库性能优化

**提出者**: 架构师、后端开发
**优化建议**:

1. **分区表设计**
```sql
-- 审计日志按月分区
CREATE TABLE lims_audit_log (...) PARTITION BY RANGE (created_at);

-- 节点数据按季度分区
CREATE TABLE lims_process_node_data (...) PARTITION BY RANGE (created_at);
```

2. **复合索引优化**
```sql
CREATE INDEX idx_sample_project_status ON lims_sample(project_id, status, created_at DESC);
CREATE INDEX idx_audit_user_time ON lims_audit_log(user_id, created_at DESC);
```

3. **JSONB字段索引**
```sql
-- 高频查询字段建立表达式索引
CREATE INDEX idx_node_data_barcode ON lims_process_node_data ((data->>'barcode'));
CREATE INDEX idx_node_data_concentration ON lims_process_node_data ((data->>'核酸浓度'));
```

---

### P2 级别 - 建议在迭代中优化

#### 问题13: 样本分装和合并的业务场景

**提出者**: 业务分析师、产品经理
**问题描述**:
- PRD提到"样本分装、合并",但具体业务场景不清
- 分装后的子样本是否独立流转?
- 合并样本的数据如何聚合?

---

#### 问题14: 质控样本的特殊处理

**提出者**: 业务分析师
**问题描述**:
- 实验室通常会在每批样本中加入质控样本(阳性对照、阴性对照)
- 当前设计未区分正常样本和质控样本
- 质控样本的处理流程可能不同

---

#### 问题15: 试剂批次追踪

**提出者**: 业务分析师
**问题描述**:
- 实验室需要记录每个节点使用的试剂批次,用于质量追溯
- 当前节点数据字段中未包含试剂批次信息

---

#### 问题16: FDA 21 CFR Part 11合规实现

**提出者**: 架构师、产品经理
**问题描述**:
- PRD要求FDA 21 CFR Part 11合规,但技术文档未详细说明:
  - 电子签名如何实现?
  - 审计追踪是否满足"不可篡改"要求?
  - 用户身份验证是否需要双因素认证?

---

#### 问题17: 多租户支持需求

**提出者**: 架构师
**问题描述**:
- 系统是否需要支持多个实验室(租户)共用?
- 数据隔离策略是什么(Schema隔离/行级隔离)?
- 流程定义是租户级别还是全局共享?

---

#### 问题18: 离线操作支持

**提出者**: 前端开发、产品经理
**问题描述**:
- 实验室网络不稳定时,是否需要离线数据录入?
- 离线数据如何同步?
- 冲突如何解决?

---

## 三、各角色审查要点

### 3.1 业务分析师审查结果

**业务流程覆盖度**: 约60%

**已覆盖场景**:
- ✅ 正常样本登记和流程流转
- ✅ 基于样本类型的条件分支
- ✅ 节点数据录入和验证
- ✅ 容器和位置管理(基础)

**缺失场景**(约40%):
- ❌ 异常流程处理(失败、暂停、取消)
- ❌ 样本分装和合并
- ❌ 容器转移和追踪
- ❌ 数据修正和审批
- ❌ 流程版本迁移
- ❌ 批量操作的事务处理
- ❌ 跨角色协作(样本转交)
- ❌ 仪器集成和自动数据采集
- ❌ 样本的长期归档和检索
- ❌ 合规性报告生成

**关键风险**:
1. 异常流程处理缺失可能导致系统上线后无法应对实际问题
2. 容器转移逻辑不清晰可能导致样本追踪出错
3. 批量操作规则不明确可能导致性能和用户体验问题

---

### 3.2 产品经理审查结果

**需求完整性**: 7/10

**优势**:
- 产品定义清晰,核心价值主张明确
- 用户角色划分合理
- 功能模块划分完整
- 业务流程描述详细

**缺陷**:
- ❌ MVP范围定义不清
- ❌ 用户故事缺失
- ❌ 验收标准不明确
- ❌ 异常场景处理不足
- ❌ 性能指标过于宽泛

**UX设计缺陷**:
- 样本登记流程缺少"流程预览"的交互说明
- 数据录入页缺少"保存草稿"和"提交"的区别说明
- 流程配置页缺少"流程版本管理"的UI设计
- 权限与可见性设计不清晰

**建议的优先级划分**:
- **MVP**(2-3个月): 样本登记、核心流程配置、基础数据录入、样本查询、简单权限
- **P1**(3-4个月): 流程可视化、容器管理、动态字段、批量操作、数据导出
- **P2**(2-3个月): 高级报表、审计日志、细粒度权限、移动端

---

### 3.3 架构师审查结果

**架构合理性**: 7.5/10

**优点**:
- 分层架构清晰
- 技术栈成熟稳定
- 动态表单设计合理
- 容器化部署方案完整

**高风险问题**:
1. Flowable流程实例与业务数据的一致性
2. 公式计算引擎安全风险(代码注入)
3. AES/ECB加密模式不安全

**中风险问题**:
1. 缺少流程版本迁移策略
2. 样本编号生成的并发问题
3. 容器孔位分配的并发控制

**技术选型建议**:
- ✅ Flowable 7.x - 适合
- ✅ PostgreSQL + JSONB - 适合
- ✅ MyBatis-Plus - 适合
- ⚠️ JavaScript ScriptEngine - 需替换为SpEL/MVEL/Aviator
- ⚠️ RabbitMQ - 如果未来需要处理大量数据流,考虑Kafka

---

### 3.4 后端开发审查结果

**技术可行性**: 7.5/10

**技术栈评估**: 合理且成熟

**数据库设计问题**:
1. 缺少分区表设计(审计日志、节点数据会快速增长)
2. 索引设计不够充分(需要复合索引)
3. 缺少乐观锁字段(样本表、容器表)
4. JSONB字段缺少约束

**Flowable集成问题**:
1. 流程版本管理缺失
2. 流程变量与业务数据分离不清晰
3. 流程监听器和事件处理缺失

**API接口问题**:
- 缺少批量操作接口
- 缺少流程管理核心接口
- 缺少任务管理接口
- 缺少数据统计和报表接口
- 缺少审计日志查询接口

**性能优化建议**:
1. 启用PostgreSQL慢查询监控
2. 配置读写分离
3. 细化缓存策略(防止缓存雪崩)
4. 使用分布式锁处理并发

**安全设计问题**:
1. JWT密钥管理不安全(建议使用RS256)
2. Token刷新机制缺失
3. 缺少API权限细粒度控制
4. 敏感数据加密方案不完整
5. 缺少XSS和CSRF防护

---

### 3.5 前端开发审查结果

**技术可行性**: 7.0/10

**技术栈评估**: 合理且成熟

**核心功能实现难度**:
1. **流程可视化设计器** - ⚠️ 高难度(3-4周)
2. **动态表单引擎** - ⚠️ 中高难度(2-3周)
3. **板位图可视化** - ⚠️ 中等难度(1-2周)
4. **流程进度可视化** - ✓ 低难度(3-5天)

**前端架构缺失**:
- ❌ 状态管理方案(Pinia)
- ❌ 路由设计和权限控制
- ❌ 组件设计规范
- ❌ 工程化配置
- ❌ 性能优化策略

**API接口缺失**:
- 流程配置相关(6个接口)
- 字段配置相关(4个接口)
- 样本批量操作(4个接口)
- 容器管理(4个接口)
- 数据统计(4个接口)
- 用户权限(3个接口)
- 审计日志(2个接口)

**性能优化缺失**:
- 首屏加载优化
- 列表虚拟滚动(10,000+数据)
- 表单性能优化
- 板位图Canvas渲染
- 缓存策略
- 打包优化

**开发排期建议**: 18-19周(约4.5个月)

---

## 四、行动计划

### 第一周(立即行动)

**产品经理**:
- [ ] 明确定义MVP范围和优先级
- [ ] 补充用户故事和验收标准
- [ ] 回答P0级别的6个关键问题
- [ ] 确定流程版本管理策略

**架构师**:
- [ ] 设计Flowable与业务数据的事务一致性方案
- [ ] 选择安全的公式计算引擎(SpEL/MVEL/Aviator)
- [ ] 设计容器孔位分配的并发控制方案
- [ ] 设计样本编号生成的高可用方案

**后端开发**:
- [ ] 补充完整的API接口设计文档
- [ ] 修复AES加密模式为AES/GCM
- [ ] 设计数据库分区表和复合索引
- [ ] 设计JWT安全机制(RS256 + Refresh Token)

**前端开发**:
- [ ] 启动bpmn-js技术预研(2周)
- [ ] 补充前端架构设计文档
- [ ] 评估动态表单引擎方案(form-create vs 自研)
- [ ] 验证虚拟滚动方案

**业务分析师**:
- [ ] 补充异常流程处理的详细说明
- [ ] 定义完整的样本状态转换规则
- [ ] 明确容器转移的业务规则
- [ ] 补充批量操作的事务处理策略

---

### 第二周

**全员**:
- [ ] 召开需求澄清会议,逐一确认P0问题的答案
- [ ] 更新需求文档和技术设计文档
- [ ] 评审更新后的文档

**架构师**:
- [ ] 完成技术方案设计评审
- [ ] 输出详细的技术实现方案

**前端开发**:
- [ ] 完成bpmn-js技术预研报告
- [ ] 确定动态表单引擎方案

---

### 第三-四周

**后端开发**:
- [ ] 完成API接口详细设计
- [ ] 完成数据库设计优化
- [ ] 搭建开发环境

**前端开发**:
- [ ] 完成前端架构设计
- [ ] 搭建项目脚手架
- [ ] 建立开发规范

**测试工程师**:
- [ ] 编写测试计划
- [ ] 设计测试用例

---

## 五、风险提示

### 高风险(可能导致项目延期或失败)

1. **bpmn-js定制化开发难度高** - 如果技术预研失败,需要考虑替代方案
2. **Flowable事务一致性问题** - 如果无法解决,可能导致数据不一致
3. **异常流程处理缺失** - 系统上线后无法应对实际问题

### 中风险(可能影响进度或质量)

1. **前端技术难点** - 动态表单引擎、板位图可视化
2. **性能优化不足** - 大数据量场景下可能出现性能问题
3. **API接口不完整** - 前后端联调时可能发现缺失

### 低风险(可控)

1. **文档细节不足** - 可以在开发过程中逐步完善
2. **部分功能优先级不清** - 可以通过迭代逐步实现

---

## 六、会议结论

1. **项目可以启动**,但必须先解决P0级别的6个关键问题
2. **建议启动2周技术预研**,验证bpmn-js和动态表单引擎的可行性
3. **需要补充完整的API接口设计**,避免前后端联调时出现问题
4. **需要明确MVP范围**,避免范围蔓延导致项目延期
5. **需要补充异常流程处理**,确保系统上线后能应对实际问题

---

## 七、下次会议安排

**时间**: 第一周结束后
**议题**:
1. 评审P0问题的解决方案
2. 评审更新后的需求文档和技术设计文档
3. 确定最终的技术方案和开发计划

**参与人**: 全体项目成员

---

**会议纪要编制**: AI协作团队
**文档版本**: v1.0
**最后更新**: 2026-02-24
