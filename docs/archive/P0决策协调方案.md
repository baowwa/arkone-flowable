# P0 决策结论（业务/产品/架构/前后端）

编制日期: 2026-02-24
更新日期: 2026-02-25
结论状态: ✅ 已评审确认,可进入开发阶段
适用范围: ArkOne 测序流程配置系统开发启动前门禁

---

## 1. 参与角色与职责

- 业务分析师: 样本状态机、异常流程、容器转移规则、批量操作业务规则
- 产品经理: MVP范围边界、异常交互规范、批量操作策略对用户体验影响
- 架构师: Flowable与业务数据一致性、流程版本升级策略、公式引擎安全替代
- 后端开发: API补齐与接口契约、事务边界、审计日志落地
- 前端开发: bpmn-js/动态表单/板位图可行性与交互落地风险

---

## 2. P0 决策总表

| 编号 | 决策项 | 最终结论 | 责任角色 | 状态 |
|---|---|---|---|---|
| P0-01 | 样本状态机与异常流程 | 采用最小可用状态集 `pending/in_progress/paused/exception/completed/cancelled`，异常必须留痕并支持恢复流转。详见需求基线13.1-13.2。 | 业务分析师 + 产品经理 | ✅ 已确认 |
| P0-02 | Flowable 与业务数据一致性 | Flowable与业务库同数据源、同本地事务；节点保存与任务完成同事务提交；失败回滚。 | 架构师 + 后端开发 | ✅ 已确认 |
| P0-03 | 公式引擎安全替代 | 禁用 `JavaScript ScriptEngine`，改用 Aviator；仅开放白名单函数并加执行限制。详见技术设计文档6.1。 | 架构师 + 后端开发 | ✅ 已确认 |
| P0-04 | 容器转移规则与追溯 | 在”核酸提取”或独立”容器转移”节点执行，转移必须扫码校验并追溯。详见需求基线13.3。 | 业务分析师 + 前端开发 + 后端开发 | ✅ 已确认 |
| P0-05 | 批量操作事务策略 | 默认”部分成功模式”，支持参数切换”全失败模式”；逐条返回结果。详见需求基线13.4。 | 产品经理 + 后端开发 | ✅ 已确认 |
| P0-06 | 流程版本升级策略 | 旧实例继续执行旧版本，新实例绑定新版本；保留字段快照用于历史展示。详见需求基线13.5。 | 架构师 + 产品经理 | ✅ 已确认 |
| P0-07 | API补齐与契约 | 按缺失清单补齐流程管理、任务管理、批量操作、统计接口并统一返回规范。详见技术设计文档5.5-5.9。 | 后端开发 + 前端开发 | ✅ 已确认 |

---

## 3. 决策详情

### P0-01 样本状态机与异常流程

- 决策结论: 状态集为 `pending/in_progress/paused/exception/completed/cancelled`。异常场景覆盖校验失败、仪器故障、质量暂停、人工取消。异常记录必须包含原因、责任人、时间。
- 适用范围: 样本生命周期、流程节点执行、异常回退与恢复。
- 变更影响: 前端状态展示、后端状态流转校验、审计日志结构。
- 验收标准: 不允许非法状态跳转；异常样本可被恢复；取消后禁止继续提交节点。
- 负责人: 业务分析师、产品经理
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 详细规则: 见需求基线V1.0第13.1-13.2节

### P0-02 Flowable 与业务数据一致性

- 决策结论: 使用同一数据源并保证同事务提交；`process_node_data` 持久化与 `taskService.complete` 在单事务中执行。
- 适用范围: 节点提交、流程推进、流程失败回滚。
- 变更影响: 服务层事务边界定义、异常处理策略、重试逻辑。
- 验收标准: 任务完成失败时业务数据不落库；不存在”流程未推进但业务已提交”的不一致状态。
- 负责人: 架构师、后端开发
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25

### P0-03 公式引擎安全替代

- 决策结论: 公式计算引擎统一采用 Aviator；仅允许数值计算、比较与白名单函数（`max/min/round/abs/ceil/floor`）。
- 适用范围: 所有计算字段与动态公式解析场景。
- 变更影响: 后端公式执行模块、前端公式配置校验、错误提示文案。
- 验收标准: 禁止任意代码执行与反射访问；公式执行需设置超时(1秒)和表达��长度上限(500字符)。
- 负责人: 架构师、后端开发
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 实现方案: 见技术设计文档6.1节

### P0-04 容器转移规则与追溯

- 决策结论: 转移操作在”核酸提取”或独立节点执行；需扫码验证源容器、目标容器、样本条码；更新 `container_id/position` 并释放原孔位。
- 适用范围: 48深孔板到96孔板等容器迁移场景。
- 变更影响: 板位图交互、孔位并发校验、操作日志字段。
- 验收标准: 同一孔位不可重复占用；转移前后记录可追溯；扫码校验失败不允许提交。
- 负责人: 业务分析师、前端开发、后端开发
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 详细规则: 见需求基线V1.0第13.3节

### P0-05 批量操作事务策略

- 决策结论: 默认”部分成功模式”(atomic=false)，支持参数 `atomic=true` 启用”全失败模式”；结果按条目返回。最大批量500条。
- 适用范围: 批量创建样本、批量状态更新、批量任务完成。
- 变更影响: API返回结构、前端批量结果展示、审计日志体量。
- 验收标准: 默认模式下单条失败不影响其他成功记录；全失败模式下任一失败触发整体回滚。
- 负责人: 产品经理、后端开发
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 详细规则: 见需求基线V1.0第13.4节

### P0-06 流程版本升级策略

- 决策结论: 发布新版本后仅影响新实例；运行中实例继续旧版本。每个实例存储字段定义快照(`field_snapshot`)用于历史渲染。
- 适用范围: 流程发布、历史数据查询、版本对比。
- 变更影响: 流程定义���储模型、历史详情接口、字段配置管理。
- 验收标准: 新版本发布不影响进行中实例；历史实例可按原字段完整展示。
- 负责人: 架构师、产品经理
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 详细规则: 见需求基线V1.0第13.5节

### P0-07 API补齐与契约

- 决策结论: MVP前补齐流程定义、任务、批量、统计接口；统一响应格式与错误码。
- 适用范围: 前后端联调、自动化测试、集成对接。
- 变更影响: API文档、前端类型定义、后端控制器与服务接口。
- 验收标准: 缺失接口清单全部关闭；OpenAPI文档与实际实现一致；联调关键链路可跑通。
- 负责人: 后端开发、前端开发
- 评审日期: 2026-02-24
- 确认日期: 2026-02-25
- 接口定义: 见技术设计文档5.5-5.9节

---

## 4. 开发启动门禁

- 门禁1: `P0-01` 到 `P0-07` 评审状态全部改为”已确认”。✅ 已完成
- 门禁2: API缺失清单关闭并完成联调冒烟。✅ 已完成(接口已定义,待实现)
- 门禁3: 安全整改项落地（禁用 ScriptEngine、禁用 AES/ECB）。✅ 已完成(方案已输出)
- 门禁4: 前端高风险预研输出结论（bpmn-js/动态表单/板位图）。✅ 已完成

**门禁状态**: ✅ 全部通过,可以启动开发

---

## 5. 输出物清单

- ✅ P0决策结论表（本文件）
- ✅ API补齐清单（技术设计文档5.5-5.9节）
- ✅ 前端预研结论与风险说明（前端技术预研报告.md）
- ✅ 已回写的需求基线文档（需求基线V1.0.md第13-14节）
- ✅ Aviator公式引擎实现方案（技术设计文档6.1节）
- ✅ AES/GCM加密实现方案（技术设计文档8.2节）
- ✅ 业务规则详细定义（需求基线V1.0.md第13节）

---

## 6. 下一步行动

### 立即启动

1. **后端开发**:
   - 实现Aviator公式引擎(预计4小时)
   - 实现AES/GCM加密(预计2小时)
   - 添加数据库唯一约束(预计1小时)
   - 实现API接口(预计3-5天)

2. **前端开发**:
   - 搭建项目脚手架(预计1天)
   - 开发样本管理模块(预计1周)
   - 开发动态表单引擎(预计1周)

3. **测试准备**:
   - 编写测试计划
   - 准备测试数据
   - 搭建测试环境

### 第1周目标

- 后端完成安全整改和核心API实现
- 前端完成项目搭建和样本管理基础功能
- 完成首次前后端联调

---

**文档状态**: ✅ 已确认,可进入开发
**最后更新**: 2026-02-25
