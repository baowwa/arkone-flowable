# ArkOne 测序流程配置系统 需求基线 V1.0（草案）

文档版本: v1.0
编制日期: 2026-02-24
适用范围: 需求评审与研发基线
来源文档: 产品需求文档、需求描述、需求对齐会议纪要、技术设计文档、UI设计方案、竞品分析报告

---

## 1. 项目定义

项目目标: 构建支持动态流程配置的测序 LIMS，按样本类型自动选择流程分支，记录节点实验数据，实现样本全生命周期追踪与管理。

业务目标:
- 流程配置效率提升 50%
- 数据录入错误率降低 80%
- 样本处理周期缩短 30%
- 样本追踪准确率 > 99.9%

---

## 2. 范围与分期

MVP范围（2-3个月）:
- 样本登记与编号生成
- 流程配置管理（预定义流程 + 基础版本管理）
- 节点数据录入与验证
- 样本查询与基础统计
- 基础权限（角色级别）

非MVP范围（后续迭代）:
- 流程可视化编辑器深度定制
- 批量操作与批量导入导出
- 容器管理与板位图可视化
- 审计日志与合规报告
- 高级统计与报表
- 外部系统集成与移动端支持

---

## 3. 用户角色与权限

角色定义:
- 实验室管理员: 流程配置、权限管理、系统监控
- 技术人员: 节点数据录入、样本处理
- 项目经理: 进度查询、统计报表
- 质量负责人: 审核数据、合规检查

权限原则:
- 基于角色的权限控制（RBAC）
- 数据可见性与操作权限分离
- 关键动作需记录审计日志

---

## 4. 业务流程基线

样本处理流程:
1. 样本登记
2. 按样本类型自动分配流程
3. 节点数据录入与验证
4. 流程完成与报告归档

流程配置流程:
1. 流程设计与节点配置
2. 字段配置与验证规则
3. 流程验证
4. 发布与版本管理

---

## 5. 测序流程配置基线

全质粒测序流程:
- 样本类型: 平板样本/沉菌、菌液样本、直抽菌液、质粒核酸样本
- 分支节点: 摇菌、核酸提取、样本前处理、文库构建、上机测序
- 按样本类型跳过部分节点

PCR 产物测序流程:
- 样本类型: PCR产物(原液)、PCR产物(已纯化)
- 分支节点: 样本前处理、文库构建、测序复合物制备及纯化、上机测序
- 按样本类型跳过样本前处理

节点字段基线:
- 摇菌: 48深孔板号、48深孔板孔号、摇菌开始时间、摇菌截止时间
- 核酸提取: 96孔板号、96孔板孔号
- 样本前处理: 核酸浓度、补ddH₂O
- 文库构建: barcode、末修产物浓度、上机文库浓度、上机文库体积、文库摩尔浓度（公式计算）
- 测序复合物制备及纯化: 投入体积

---

## 6. 功能需求基线

流程配置管理:
- 可视化流程设计与发布
- 条件分支配置
- 流程模板与版本管理

样本管理:
- 样本登记与编号生成
- 容器与孔位管理
- 样本状态追踪
- 样本关系管理（分装/合并）

节点数据录入:
- 动态字段渲染
- 数据校验与实时提示
- 公式计算字段

数据查询与统计:
- 多条件查询
- 进度统计
- 数据导出

权限与审计:
- RBAC
- 操作审计日志
- 数据变更追踪

---

## 7. 核心页面基线

页面清单:
- 样本登记
- 样本列表
- 样本详情
- 流程配置
- 数据录入
- 板位管理
- 字段配置
- 数据统计

关键交互要求:
- 样本登记需支持流程预览
- 数据录入区分保存草稿与提交
- 表单字段实时校验与计算
- 支持扫码输入与批量操作入口

---

## 8. 数据模型与存储

核心数据表（示意级别）:
- lims_sample
- lims_project
- lims_process_node_data
- lims_field_definition
- lims_container
- lims_audit_log

动态字段存储:
- 节点数据使用 JSONB
- 高频字段建立表达式索引

---

## 9. 非功能与合规基线

性能指标:
- 流程实例启动时间 < 500ms
- 样本查询响应时间 < 200ms
- 并发处理能力 10,000+ 样本
- 系统可用性 > 99.5%

安全要求:
- 数据加密存储
- 访问控制与认证
- API限流与防护

合规要求:
- FDA 21 CFR Part 11
- ISO/IEC 17025
- 完整审计追踪

---

## 10. API 基线（MVP必需）

样本管理:
- POST /samples
- GET /samples
- GET /samples/{id}

流程配置:
- GET /process/nodes/{nodeId}/fields
- POST /process/tasks/{taskId}/complete

容器管理:
- GET /containers/{containerId}/plate-map

统计:
- GET /statistics/samples/status

---

## 11. API 缺失清单（需补齐）

流程管理:
- GET /process/definitions
- POST /process/definitions
- GET /process/definitions/{id}/xml
- POST /process/instances/{id}/suspend

任务管理:
- GET /process/tasks/my
- POST /process/tasks/{id}/claim
- POST /process/tasks/{id}/delegate

批量操作:
- POST /samples/batch
- PUT /samples/batch/status
- POST /process/tasks/batch/complete

统计报表:
- GET /statistics/process/performance
- GET /statistics/nodes/duration

---

## 12. 验收标准（示例）

样本登记:
- 能生成唯一样本编号
- 提交后自动启动流程实例
- 样本状态由 pending 进入 in_progress

节点数据录入:
- 必填字段缺失时不能提交
- 公式字段自动计算并落库
- 提交后流程进入下一节点

流程配置:
- 支持按样本类型分支
- 版本发布后可查询版本列表

查询统计:
- 支持按状态/项目/时间筛选
- 统计与导出结果一致

性能:
- P95 响应时间满足指标

---


## 13. 业务规则详细定义

### 13.1 样本状态转换矩阵

| 当前状态 | 可转换状态 | 触发条件 | 权限要求 |
|---------|-----------|---------|---------|
| pending | in_progress | 流程启动 | 技术人员 |
| pending | cancelled | 人工取消 | 项目经理/管理员 |
| in_progress | paused | 人工暂停 | 技术人员 |
| in_progress | exception | 校验失败/仪器故障 | 系统自动 |
| in_progress | completed | 所有节点完成 | 系统自动 |
| in_progress | cancelled | 人工取消 | 项目经理/管理员 |
| paused | in_progress | 恢复流程 | 技术人员 |
| paused | cancelled | 人工取消 | 项目经理/管理员 |
| exception | in_progress | 异常修复后恢复 | 质量负责人 |
| exception | cancelled | 无法修复 | 质量负责人 |
| completed | - | 终态，不可转换 | - |
| cancelled | - | 终态，不可转换 | - |

### 13.2 异常流程处理规则

#### 异常类型定义

| 异常类型 | 触发条件 | 处理流程 | 数据保留策略 |
|---------|---------|---------|-------------|
| VALIDATION_FAILED | 字段验证失败 | 1. 记录异常原因<br>2. 通知责任人<br>3. 允许修正后重新提交 | 保留草稿数据 |
| INSTRUMENT_FAILURE | 仪器故障 | 1. 记录故障信息<br>2. 暂停相关样本<br>3. 仪器修复后批量恢复 | 保留已提交数据 |
| QUALITY_PAUSE | 质量问题暂停 | 1. 质量负责人审核<br>2. 确定处理方案<br>3. 审批后恢复或取消 | 保留所有数据 |
| MANUAL_CANCEL | 人工取消 | 1. 填写取消原因<br>2. 审批确认<br>3. 归档数据 | 保留所有数据，标记已取消 |

#### 异常恢复前置条件

- **VALIDATION_FAILED**: 修正数据并通过验证
- **INSTRUMENT_FAILURE**: 仪器状态恢复正常
- **QUALITY_PAUSE**: 质量负责人审批通过
- **MANUAL_CANCEL**: 不可恢复

#### 异常记录必填字段

```json
{
  "exceptionType": "VALIDATION_FAILED",
  "exceptionReason": "核酸浓度超出范围(1200 ng/μL)",
  "exceptionTime": "2026-02-24T14:30:00",
  "responsiblePerson": "张三",
  "currentNode": "样本前处理",
  "recoveryAction": "修正数据后重新提交"
}
```

### 13.3 容器转移规则

#### 转移场景定义

| 源容器类型 | 目标容器类型 | 转移节点 | 映射规则 |
|-----------|-------------|---------|---------|
| 48深孔板 | 96孔板 | 核酸提取 | 1:2映射(A01→A01,A02) |
| 96孔板 | 96孔板 | 独立转移节点 | 1:1映射 |
| 试管 | 96孔板 | 样本登记 | 手动指定 |

#### 转移操作流程

1. **扫码验证**
   - 扫描源容器条码
   - 扫描目标容器条码
   - 扫描样本条码(逐个)

2. **孔位校验**
   - 检查目标孔位是否为空
   - 检查样本是否在源容器中
   - 检查容器类型兼容性

3. **执行转移**
   - 更新样本 `container_id` 和 `position`
   - 释放源容器孔位(设置为empty)
   - 占用目标容器孔位(设置为used)

4. **追溯记录**
   ```json
   {
     "operationType": "CONTAINER_TRANSFER",
     "sampleId": "uuid",
     "sourceContainer": "P048-001",
     "sourcePosition": "A01",
     "targetContainer": "P096-002",
     "targetPosition": "A01",
     "operator": "李四",
     "operationTime": "2026-02-24T15:00:00"
   }
   ```

#### 孔位冲突处理

- **检测机制**: 数据库唯一约束 `UNIQUE(container_id, position, deleted=false)`
- **冲突响应**: 返回错误码 `POSITION_OCCUPIED`，提示用户选择其他孔位
- **并发控制**: 使用乐观锁(`version`字段)防止并发冲突

#### 批量转移规则

- 48深孔板→96孔板: 按行映射(A行→A行前半部分)
- 最大批量: 48个样本/次
- 事务策略: 全成功或全失败(atomic=true)
- 失败回滚: 所有孔位状态恢复

### 13.4 批量操作策略

#### 部分成功模式(默认)

```json
{
  "atomic": false,
  "samples": [...]
}
```

- 逐条处理，独立事务
- 单条失败不影响其他记录
- 返回每条记录的处理结果
- 每条操作独立写入审计日志

#### 全失败模式

```json
{
  "atomic": true,
  "samples": [...]
}
```

- 所有记录在同一事务中
- 任一失败触发整体回滚
- 返回首个失败原因
- 仅在全部成功时写入审计日志

#### 批量操作限制

- 最大批量数: 500条/次
- 超时时间: 60秒
- 失败重试: 支持失败记录单独重试

#### 结果展示规范

```json
{
  "successCount": 450,
  "failureCount": 50,
  "results": [
    {
      "index": 0,
      "success": true,
      "data": {...}
    },
    {
      "index": 10,
      "success": false,
      "errorCode": "DUPLICATE_SAMPLE_NAME",
      "errorMessage": "样本名称已存在: Sample-011"
    }
  ],
  "failuresByType": {
    "DUPLICATE_SAMPLE_NAME": 30,
    "VALIDATION_FAILED": 20
  }
}
```

### 13.5 流程版本管理规则

#### 版本发布策略

- 新版本发布后，仅影响新创建的流程实例
- 运行中的实例继续使用启动时的版本
- 版本号自动递增(v1, v2, v3...)

#### 字段快照机制

**快照时机**: 流程实例启动时

**快照内容**:
```json
{
  "processDefinitionId": "plasmid_sequencing:3:12345",
  "version": 3,
  "fieldDefinitions": {
    "task_shake": [
      {
        "fieldName": "48深孔板号",
        "fieldType": "text",
        "required": true
      }
    ]
  }
}
```

**存储位置**: `lims_process_node_data.field_snapshot` (JSONB)

#### 历史数据展示

- 优先使用字段快照渲染
- 快照缺失时使用当前版本定义(标注"字段定义已变更")
- 版本对比功能显示字段差异

#### 版本回滚策略

- 支持停用当前版本(status=inactive)
- 支持激活历史版本(status=active)
- 不支持删除已使用的版本

### 13.6 并发控制规则

#### 孔位分配并发控制

- 数据库唯一约束: `UNIQUE(container_id, position, deleted=false)`
- 乐观锁: `version` 字段
- 冲突重试: 最多3次，间隔100ms

#### 样本状态并发控制

- 乐观锁: `version` 字段
- 状态转换校验: 检查当前状态是否允许目标状态
- 冲突响应: 返回 `CONCURRENT_MODIFICATION` 错误

#### 任务认领并发控制

- Flowable内置锁机制
- 首次认领成功，后续认领失败
- 返回 `TASK_ALREADY_CLAIMED` 错误

---

## 14. P0 决策结论（已确认）

| 决策项 | 结论（建议方案） | 当前状态 |
|---|---|---|
| 样本状态机与异常流程 | 采用最小可用状态集 `pending/in_progress/paused/exception/completed/cancelled`。异常场景覆盖校验失败、仪器故障、质量暂停、人工取消，必须记录原因、责任人、时间，且支持恢复至 `in_progress`。详见13.1和13.2。 | ✅ 已确认 |
| Flowable与业务数据一致性 | Flowable 与业务数据使用同一数据源；节点数据保存与 `taskService.complete` 在同一事务中提交；失败自动回滚；跨服务场景后续引入 Saga 补偿。 | ✅ 已确认 |
| 公式引擎安全替代 | 替换 `JavaScript ScriptEngine` 为 Aviator；仅允许数值计算与白名单函数(max/min/round/abs/ceil/floor)，限制表达式长度500字符并设置执行超时1秒。 | ✅ 已确认 |
| 容器转移规则 | 转移在”核酸提取”节点或独立节点执行；必须扫码验证源容器、目标容器、样本条码；更新样本 `container_id/position`，释放原孔位并记录追溯日志。详见13.3。 | ✅ 已确认 |
| 批量操作事务策略 | 默认”部分成功模式”(atomic=false)，支持参数切换”全失败模式”(atomic=true)；每条记录独立事务并返回逐条失败原因；每条操作写入审计日志。最大批量500条。详见13.4。 | ✅ 已确认 |
| 流程版本升级策略 | 旧实例继续走旧版本，新实例使用最新版本；字段结构按实例启动时版本快照保存到`field_snapshot`字段，历史数据展示按快照渲染；支持版本停用和激活。详见13.5。 | ✅ 已确认 |
| API补齐与契约 | 已补齐流程管理、任务管理、批量操作、统计接口；统一请求/响应格式与错误码。详见技术设计文档5.5-5.9。 | ✅ 已确认 |

## 15. 风险与依赖

高风险:
- bpmn-js 深度定制可行性 (已通过前端技术预研降低风险)
- 事务一致性与异常流程覆盖 (已通过业务规则详细定义解决)
- 安全合规实现路径 (已完成Aviator和AES/GCM方案)

依赖:
- ✅ 后端接口设计补齐 (已完成)
- ✅ 前端关键技术预研结论 (见前端技术预研报告)
- 合规要求明确落地 (FDA 21 CFR Part 11待后续迭代)

---

## 16. 里程碑（建议）

阶段1: 核心流程引擎（2-3个月）
阶段2: 业务功能开发（3-4个月）
阶段3: 用户界面（2-3个月）
阶段4: 高级功能（2-3个月）

---

文档状态: 已评审确认，可进入开发阶段
最后更新: 2026-02-25

